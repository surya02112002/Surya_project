{% extends 'layout.html' %}
{% block title %}Doctor's Appointments - Skintellect{% endblock %}
{% block content %}
<div class="appointments-container">
  <div class="appointments-box">
    <h1>Doctor's Appointments</h1>
    <div id="appointmentsContainer"></div>
  </div>
</div>
<script>
    // Use tojson filter to safely convert Python data to JSON.
    var appointments = {{ appointments | tojson }};
    var container = document.getElementById("appointmentsContainer");
    console.log(appointments);

    if (appointments.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center">No appointments available.</p>`;
    } else {
        appointments.forEach(function(appointment) {
            var appointmentDiv = document.createElement("div");
            appointmentDiv.classList.add("appointment-card");

            var status = appointment[8] == 0 ? "Pending" : "Accepted";
            var content = `
                <strong>Name:</strong> ${appointment[1]}<br>
                <strong>Email:</strong> ${appointment[2]}<br>
                <strong>Date:</strong> ${appointment[3]}<br>
                <strong>Skin type:</strong> ${appointment[4]}<br>
                <strong>Status:</strong> <span id="status-${appointment[0]}">${status}</span><br>
            `;
            appointmentDiv.innerHTML = content;

            var appointmentActions = document.createElement("div");
            appointmentActions.classList.add("appointment-actions");

            // Check icon (only if pending)
            if (appointment[8] == 0) {
                var checkIcon = document.createElement("i");
                checkIcon.classList.add("fa-solid", "fa-check");
                checkIcon.onclick = function() {
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/update_status", true);
                    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            document.getElementById(`status-${appointment[0]}`).innerText = "Accepted";
                            alert("Appointment updated successfully!");
                        }
                    };
                    xhr.send("appointment_id=" + appointment[0]);
                };
                appointmentActions.appendChild(checkIcon);
            }

            // Delete icon
            var deleteIcon = document.createElement("i");
            deleteIcon.classList.add("fa-solid", "fa-trash");
            deleteIcon.onclick = function() {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "/delete_user_request", true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        window.location.reload();
                    }
                };
                xhr.send("id=" + appointment[0]);
            };
            appointmentActions.appendChild(deleteIcon);

            appointmentDiv.appendChild(appointmentActions);
            container.appendChild(appointmentDiv);
        });
    }
</script>
{% endblock %}
